---
title: "オートシェイプで作図―フリーフォームで円弧を描く"
emoji: "👻"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["VBA", "Excel", "オートシェイプ", "ベジェ曲線"]
published: false
---

# フリーフォームで図を描きたい

Excelのワークシート上に図を描くとき、オートシェイプのフリーフォームを使うと直線とベジェ曲線を組み合わせた形状を作成できます。では「直線と円弧」で図を描くには？ 本記事ではVBAでベジェ曲線を円弧に近似させる方法を模索します。

なお、今回は諸事情^[ことの発端がExcelで図面交換形式のDXFファイルを生成したいというところにあるため、諸々をDXFに都合のいいように決めています。]により入力データの作り方にちょっと癖があります。たとえば座標系について、ExcelではY軸下向きがプラス、本記事の入力データはY軸**上向き**がプラス、など。

# 目次

内容が盛りだくさんなので記事を分けます。今回はベジェ曲線の制御点を求めるところまで。VBAのコードは次回をお待ちください。

- フリーフォームで円弧を描く（1）← 本記事
- フリーフォームで円弧を描く（2）← VBAでコーディングの予定

# 結論

ベジェ曲線を円弧で近似するとき、内角を$2 \theta$として$0 \lt 2 \theta \le \pi / 2$の範囲で制御点は次のとおり。

$$
P_1 = (x_1, y_1) = \left(r, \frac{4(1 - \cos \theta )}{3 \sin \theta} r \right) \\
P_2 = (x_2, y_2) = \left(
    \cos 2 \theta + y_1 \sin 2 \theta,
    \sin 2 \theta - y_1 \cos 2 \theta
  \right)
$$

# 制御点の座標の導出

任意角度の円弧をベジェ曲線で近似するための制御点座標を導出します。

## 三次ベジェ曲線の式

三次ベジェ曲線は次のような式で表されるようです。$P_0$が視点、$P_1$と$P_2$が制御点、$P_3$が終点です。

$$
B(t) = (1-t)^3 P_0 + 3(1-t)^2 t P_1 + 3(1-t) t^2 P_2 + t^3 P_3
$$

ベジェ曲線で円を近似するときは、内角90度ずつに分割して、始点（0度）、終点（90度）の他に中間点（45度）が円と重なるように制御点を決めていることが多いようです。

## 円弧近似の方針

ということは、90度までならほぼ円弧とみなせる、それより大きな角度では歪になるかもしれない、と判断しましょう。内角が90度を超える円弧を描きたいときは、複数区間に等分してそれぞれが内角90度以内になる方針とします。

## X座標について求める

上記B(t)の式について、t=0.5の点が円弧上に来るようにします。円弧の内角を$0 \le 2 \theta \ge \pi / 2$として変形していきます。中間点の座標を計算しやすくするために内角が$2 \theta$になっていますので気を付けてください。

$$
B(0.5) = 0.5^3 P_0 + 3 \times 0.5^3 P_1 + 3 \times 0.5^3 P_2 + 0.5^3 P_3 \\
= \frac{1}{8} (P_0 + 3P_1 + 3P_2 + P_3)
$$

X座標に注目すると、

$$
Bx(0.5) = \frac{1}{8} (1 + 3 \times 1 + 3 x_2 + \cos 2 \theta) = \cos \theta
$$

となります。ところで、$P_2$は$P_1$をx軸で反転してから$2 \theta$だけ回転移動させた点なので、次のように$P_1$で表せます。

$$
  P_2 = \left[
    \begin{array}{r}
    x_2 \\
    y_2
    \end{array}
  \right] = \left[
    \begin{array}{rr}
      \cos 2 \theta & - \sin 2 \theta \\
      \sin 2 \theta & \cos 2 \theta
    \end{array}
  \right]
  \left[
    \begin{array}{r}
      1 \\
      -y_1
    \end{array}
  \right]
  = \left[
    \begin{array}{r}
      \cos 2 \theta + y_1 \sin 2 \theta \\
      \sin 2 \theta - y_1 \cos 2 \theta
    \end{array}
  \right]
$$

これを代入して$y_1$について整理すると、

$$
y_1 = \frac{8 \cos \theta - 4 - 4 \cos 2 \theta}{3 \sin 2 \theta} = \frac{4(1 - \cos \theta )}{3 \sin \theta}
$$


となります。

# 参考にした資料

